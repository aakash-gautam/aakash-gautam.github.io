<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YouTube Playlist Link Extractor</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#e2e8f0;
      --primary:#0b5f3b;
      --primary-2:#094c2f;
      --danger:#b91c1c;
      --warn:#b45309;
      --shadow: 0 8px 24px rgba(2,6,23,.08);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(11,95,59,.10), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(2,132,199,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1050px;
      margin: 0 auto;
      padding: 28px 16px 60px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    h1{
      margin:0;
      font-size: clamp(1.4rem, 2.5vw, 2.1rem);
      line-height:1.15;
      letter-spacing:-0.02em;
    }
    .sub{
      margin: 10px 0 0;
      color:var(--muted);
      max-width: 820px;
      line-height:1.5;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(6px);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{
      margin:0 0 10px;
      font-size: 1.05rem;
      letter-spacing:-0.01em;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input[type="text"], input[type="password"], select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      outline: none;
      font-size: 14px;
      background:#fff;
      color:var(--text);
    }
    input[type="text"]:focus, input[type="password"]:focus, select:focus, textarea:focus{
      border-color: rgba(11,95,59,.45);
      box-shadow: 0 0 0 4px rgba(11,95,59,.10);
    }
    .btn{
      appearance:none;
      border:0;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 650;
      cursor:pointer;
      transition: transform .03s ease, background .15s ease, box-shadow .15s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      line-height:1;
      font-size: 14px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: var(--primary);
      color:#fff;
      box-shadow: 0 10px 18px rgba(11,95,59,.18);
    }
    .btn.primary:hover{background: var(--primary-2)}
    .btn.ghost{
      background: #fff;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn.ghost:hover{
      background: rgba(148,163,184,.12);
    }
    .btn.danger{
      background: rgba(185,28,28,.10);
      border:1px solid rgba(185,28,28,.25);
      color: var(--danger);
    }
    .btn.danger:hover{
      background: rgba(185,28,28,.14);
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.45;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width: 520px){ .kv{grid-template-columns:1fr} }
    .stat{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(2,6,23,.02);
    }
    .stat .k{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .stat .v{
      font-size: 16px;
      font-weight: 750;
      letter-spacing: -0.01em;
    }
    .progress{
      height: 10px;
      background: rgba(148,163,184,.25);
      border-radius: 999px;
      overflow:hidden;
      border:1px solid var(--border);
    }
    .bar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), #16a34a);
      transition: width .2s ease;
    }
    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.02);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .msg.error{
      border-color: rgba(185,28,28,.28);
      background: rgba(185,28,28,.08);
      color: #7f1d1d;
    }
    .msg.warn{
      border-color: rgba(180,83,9,.28);
      background: rgba(180,83,9,.08);
      color: #7c2d12;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin: 12px 0 10px;
    }
    .toolbar .left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background:#fff;
      color: var(--muted);
      font-size: 12px;
    }
    textarea{
      min-height: 280px;
      resize: vertical;
      font-family: var(--mono);
      font-size: 12.5px;
      line-height: 1.5;
      white-space: pre;
    }
    .list{
      margin-top: 10px;
      max-height: 280px;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 14px;
    }
    .item{
      padding: 10px 12px;
      display:flex;
      gap:10px;
      border-bottom: 1px solid var(--border);
      background:#fff;
    }
    .item:last-child{border-bottom:0}
    .idx{
      width: 34px;
      flex:0 0 auto;
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
    }
    .itxt{
      min-width:0;
      flex:1;
    }
    .title{
      font-size: 13px;
      font-weight: 650;
      margin:0 0 4px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }
    a{color: var(--primary); text-decoration:none}
    a:hover{text-decoration:underline}
    footer{
      margin-top: 18px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.5;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(2,6,23,.02);
    }
    .toggle input{transform: scale(1.1)}
    .help{
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 12px;
      background: rgba(2,6,23,.02);
    }
    .help summary{
      cursor:pointer;
      font-weight: 700;
    }
    .help ul{
      margin: 10px 0 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }
    .muted{color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>YouTube Playlist Link Extractor</h1>
        <p class="sub">
          Paste a YouTube playlist URL and extract all video <b>titles + links</b>. Export as Text, Markdown, or CSV.
          This tool uses the official YouTube Data API (metadata only).
        </p>
      </div>
      <div class="badge">No login • Metadata only • Client-side UI</div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>1) Paste playlist URL</h2>

        <label for="playlistUrl">YouTube Playlist URL</label>
        <input id="playlistUrl" type="text" placeholder="https://www.youtube.com/playlist?list=PL..." />

        <div class="row" style="margin-top:12px;">
          <button id="btnExtract" class="btn primary" style="flex:1; min-width: 220px;">
            Extract Playlist Links
          </button>
          <button id="btnClear" class="btn ghost">Clear</button>
        </div>

        <div class="kv">
          <div class="stat">
            <div class="k">Videos found</div>
            <div class="v" id="statCount">—</div>
          </div>
          <div class="stat">
            <div class="k">Total duration</div>
            <div class="v" id="statDuration">—</div>
          </div>
          <div class="stat">
            <div class="k">Invested time (at 1.25×)</div>
            <div class="v" id="statDuration125">—</div>
          </div>
          <div class="stat">
            <div class="k">Invested time (at 1.5×)</div>
            <div class="v" id="statDuration150">—</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="progress" aria-label="progress">
            <div class="bar" id="bar"></div>
          </div>
          <div class="hint" id="progressText">Ready.</div>
        </div>

        <div id="message" class="msg" style="display:none;"></div>

        <details class="help">
          <summary>API Key (required)</summary>
          <div class="hint" style="margin-top:8px;">
            YouTube blocks playlist metadata without an API key. Create a free key in Google Cloud Console (YouTube Data API v3),
            then paste it below. It stays only in your browser (localStorage) unless you clear it.
          </div>

          <label for="apiKey" style="margin-top:12px;">YouTube Data API Key</label>
          <input id="apiKey" type="password" placeholder="Paste your API key here" />

          <div class="row" style="margin-top:10px;">
            <button id="btnSaveKey" class="btn ghost">Save Key</button>
            <button id="btnForgetKey" class="btn danger">Forget Key</button>
            <span class="small" id="keyStatus"></span>
          </div>

          <div class="hint">
            Notes:
            <ul>
              <li>Quota applies (YouTube API). Normal playlists are fine.</li>
              <li>This tool fetches metadata only (title, video ID, duration).</li>
              <li>Private playlists/videos may not appear.</li>
            </ul>
          </div>
        </details>
      </section>

      <section class="card">
        <h2>2) Output</h2>

        <div class="toolbar">
          <div class="left">
            <span class="pill" id="playlistTitlePill">Playlist: —</span>
            <span class="pill" id="channelPill">Channel: —</span>
          </div>

          <div class="left">
            <select id="format">
              <option value="text">Plain Text</option>
              <option value="markdown">Markdown</option>
              <option value="csv">CSV</option>
            </select>
            <button id="btnCopy" class="btn ghost">Copy</button>
            <button id="btnDownload" class="btn ghost">Download</button>
          </div>
        </div>

        <label for="output">Extracted content</label>
        <textarea id="output" placeholder="Extracted links will appear here..." readonly></textarea>

        <div class="toggle" style="margin-top:12px;">
          <input type="checkbox" id="includeDuration" checked />
          <div>
            <div style="font-weight:700;">Include durations in output</div>
            <div class="small">Useful for planning study time.</div>
          </div>
        </div>

        <div class="list" id="previewList" style="display:none; margin-top:12px;"></div>

        <footer>
          Tip: If you’re building notes (Notion/Docs), choose <b>Markdown</b>. For Excel, choose <b>CSV</b>.
        </footer>
      </section>
    </div>
  </div>

<script>
  const els = {
    playlistUrl: document.getElementById('playlistUrl'),
    apiKey: document.getElementById('apiKey'),
    btnExtract: document.getElementById('btnExtract'),
    btnClear: document.getElementById('btnClear'),
    btnSaveKey: document.getElementById('btnSaveKey'),
    btnForgetKey: document.getElementById('btnForgetKey'),
    keyStatus: document.getElementById('keyStatus'),
    bar: document.getElementById('bar'),
    progressText: document.getElementById('progressText'),
    message: document.getElementById('message'),
    statCount: document.getElementById('statCount'),
    statDuration: document.getElementById('statDuration'),
    statDuration125: document.getElementById('statDuration125'),
    statDuration150: document.getElementById('statDuration150'),
    playlistTitlePill: document.getElementById('playlistTitlePill'),
    channelPill: document.getElementById('channelPill'),
    format: document.getElementById('format'),
    output: document.getElementById('output'),
    btnCopy: document.getElementById('btnCopy'),
    btnDownload: document.getElementById('btnDownload'),
    includeDuration: document.getElementById('includeDuration'),
    previewList: document.getElementById('previewList'),
  };

  const LS_KEY = "yt_playlist_extractor_api_key_v1";

  let state = {
    playlistId: null,
    playlistTitle: null,
    channelTitle: null,
    items: [], // {index, videoId, title, url, durationSec}
    totalDurationSec: 0
  };

  function setMsg(text, type="info"){
    if(!text){
      els.message.style.display = "none";
      els.message.className = "msg";
      els.message.textContent = "";
      return;
    }
    els.message.style.display = "block";
    els.message.className = "msg" + (type==="error" ? " error" : type==="warn" ? " warn" : "");
    els.message.textContent = text;
  }

  function setProgress(pct, text){
    const clamped = Math.max(0, Math.min(100, pct));
    els.bar.style.width = clamped + "%";
    els.progressText.textContent = text || "Working...";
  }

  function parsePlaylistId(url){
    try{
      const u = new URL(url.trim());
      const list = u.searchParams.get("list");
      if(list) return list;
      // youtu.be links sometimes have ?list=
      // Also support raw playlistId
    }catch(e){
      // if it's not a URL, maybe it's the raw ID
    }
    const raw = url.trim();
    // Basic playlist id pattern often starts with PL, UU, OL, RD, etc.
    if(raw.length >= 10 && /^[a-zA-Z0-9_-]+$/.test(raw)) return raw;
    return null;
  }

  function formatHMS(totalSec){
    if(!Number.isFinite(totalSec) || totalSec < 0) return "—";
    const s = Math.floor(totalSec);
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const r = s % 60;
    if(h > 0) return `${h}h ${m}m ${r}s`;
    if(m > 0) return `${m}m ${r}s`;
    return `${r}s`;
  }

  function iso8601DurationToSec(iso){
    // PT#H#M#S
    if(!iso || typeof iso !== "string") return 0;
    const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
    if(!m) return 0;
    const h = parseInt(m[1] || "0", 10);
    const min = parseInt(m[2] || "0", 10);
    const s = parseInt(m[3] || "0", 10);
    return h*3600 + min*60 + s;
  }

  function chunk(arr, size){
    const out = [];
    for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
    return out;
  }

  function safeCSVCell(v){
    const s = String(v ?? "");
    if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  function buildOutput(){
    const includeDur = els.includeDuration.checked;
    const fmt = els.format.value;

    const lines = [];
    const title = state.playlistTitle ? `Playlist: ${state.playlistTitle}` : "Playlist: (unknown)";
    const channel = state.channelTitle ? `Channel: ${state.channelTitle}` : "Channel: (unknown)";
    const total = `Total Duration: ${formatHMS(state.totalDurationSec)}`;

    if(fmt === "text"){
      lines.push(title);
      lines.push(channel);
      lines.push(total);
      lines.push("");
      state.items.forEach((it) => {
        const dur = includeDur ? ` [${formatHMS(it.durationSec)}]` : "";
        lines.push(`${it.index}. ${it.title}${dur}`);
        lines.push(it.url);
        lines.push("");
      });
      return lines.join("\n").trim();
    }

    if(fmt === "markdown"){
      lines.push(`# ${state.playlistTitle || "YouTube Playlist"}`);
      lines.push(`- **Channel:** ${state.channelTitle || "—"}`);
      lines.push(`- **Total Duration:** ${formatHMS(state.totalDurationSec)}`);
      lines.push("");
      state.items.forEach((it) => {
        const dur = includeDur ? ` — \`${formatHMS(it.durationSec)}\`` : "";
        lines.push(`${it.index}. [${it.title}](${it.url})${dur}`);
      });
      return lines.join("\n");
    }

    // csv
    lines.push(["Index","Title","URL", ...(includeDur ? ["Duration"] : [])].join(","));
    state.items.forEach((it) => {
      const row = [
        safeCSVCell(it.index),
        safeCSVCell(it.title),
        safeCSVCell(it.url),
        ...(includeDur ? [safeCSVCell(formatHMS(it.durationSec))] : [])
      ].join(",");
      lines.push(row);
    });
    return lines.join("\n");
  }

  function renderPreviewList(){
    const list = els.previewList;
    if(state.items.length === 0){
      list.style.display = "none";
      list.innerHTML = "";
      return;
    }
    list.style.display = "block";
    list.innerHTML = state.items.slice(0, 60).map(it => {
      const dur = it.durationSec ? `<span>⏱ ${formatHMS(it.durationSec)}</span>` : "";
      return `
        <div class="item">
          <div class="idx">${it.index}.</div>
          <div class="itxt">
            <div class="title" title="${escapeHtml(it.title)}">${escapeHtml(it.title)}</div>
            <div class="meta">
              <a href="${it.url}" target="_blank" rel="noreferrer">Open</a>
              <span class="muted">${escapeHtml(it.videoId)}</span>
              ${dur}
            </div>
          </div>
        </div>
      `;
    }).join("");
    if(state.items.length > 60){
      list.insertAdjacentHTML("beforeend", `
        <div class="item" style="justify-content:center; color: var(--muted); font-size: 12px;">
          Preview shows first 60 videos. Export to get the full list.
        </div>
      `);
    }
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function updateUIAfterExtract(){
    els.statCount.textContent = state.items.length ? String(state.items.length) : "—";
    els.statDuration.textContent = state.items.length ? formatHMS(state.totalDurationSec) : "—";
    els.statDuration125.textContent = state.items.length ? formatHMS(Math.round(state.totalDurationSec / 1.25)) : "—";
    els.statDuration150.textContent = state.items.length ? formatHMS(Math.round(state.totalDurationSec / 1.5)) : "—";

    els.playlistTitlePill.textContent = `Playlist: ${state.playlistTitle || "—"}`;
    els.channelPill.textContent = `Channel: ${state.channelTitle || "—"}`;

    els.output.value = buildOutput();
    renderPreviewList();
  }

  async function ytFetch(url, apiKey){
    const r = await fetch(url, { method: "GET" });
    if(!r.ok){
      let msg = `HTTP ${r.status}`;
      try{
        const j = await r.json();
        if(j?.error?.message) msg = j.error.message;
      }catch(e){}
      throw new Error(msg);
    }
    return r.json();
  }

  async function fetchPlaylistMetaAndItems({playlistId, apiKey}){
    const base = "https://www.googleapis.com/youtube/v3";
    const items = [];

    // playlist metadata (title, channel)
    const plUrl = `${base}/playlists?part=snippet&id=${encodeURIComponent(playlistId)}&key=${encodeURIComponent(apiKey)}`;
    const plJson = await ytFetch(plUrl, apiKey);
    if(!plJson.items || plJson.items.length === 0){
      throw new Error("Playlist not found or not accessible. If it’s private, it won’t work without OAuth.");
    }
    const pl = plJson.items[0];
    const playlistTitle = pl.snippet?.title || null;
    const channelTitle = pl.snippet?.channelTitle || null;

    // playlistItems pagination
    let pageToken = "";
    let page = 0;
    while(true){
      page++;
      const url = `${base}/playlistItems?part=snippet,contentDetails&maxResults=50&playlistId=${encodeURIComponent(playlistId)}${pageToken ? `&pageToken=${encodeURIComponent(pageToken)}` : ""}&key=${encodeURIComponent(apiKey)}`;
      const json = await ytFetch(url, apiKey);

      const batch = (json.items || []).map(it => {
        const videoId = it.contentDetails?.videoId;
        const title = it.snippet?.title || "(no title)";
        // YouTube sometimes returns "Private video" / "Deleted video"
        return { videoId, title };
      }).filter(x => x.videoId);

      items.push(...batch);

      setProgress(Math.min(45, 10 + page * 10), `Fetched ${items.length} playlist items...`);

      if(json.nextPageToken){
        pageToken = json.nextPageToken;
      } else {
        break;
      }

      // safety: avoid runaway loops
      if(page > 200) break;
    }

    return { playlistTitle, channelTitle, rawItems: items };
  }

  async function fetchDurationsForVideoIds({videoIds, apiKey}){
    const base = "https://www.googleapis.com/youtube/v3";
    const map = new Map(); // id -> seconds
    const groups = chunk(videoIds, 50);
    for(let i=0;i<groups.length;i++){
      const ids = groups[i].join(",");
      const url = `${base}/videos?part=contentDetails&id=${encodeURIComponent(ids)}&maxResults=50&key=${encodeURIComponent(apiKey)}`;
      const json = await ytFetch(url, apiKey);
      (json.items || []).forEach(v => {
        const id = v.id;
        const durIso = v.contentDetails?.duration || "PT0S";
        map.set(id, iso8601DurationToSec(durIso));
      });
      const pct = 45 + Math.round(((i+1)/groups.length) * 50);
      setProgress(pct, `Fetched durations (${i+1}/${groups.length})...`);
    }
    return map;
  }

  async function extract(){
    setMsg("");
    const apiKey = (els.apiKey.value || localStorage.getItem(LS_KEY) || "").trim();
    if(!apiKey){
      setMsg("Please add your YouTube Data API key (open the API Key section) and try again.", "warn");
      els.apiKey.focus();
      return;
    }

    const playlistId = parsePlaylistId(els.playlistUrl.value);
    if(!playlistId){
      setMsg("Please paste a valid YouTube playlist URL (or playlist ID).", "warn");
      els.playlistUrl.focus();
      return;
    }

    state = { playlistId, playlistTitle:null, channelTitle:null, items:[], totalDurationSec:0 };
    updateUIAfterExtract();

    els.btnExtract.disabled = true;
    els.btnExtract.textContent = "Extracting...";
    setProgress(5, "Starting...");

    try{
      const { playlistTitle, channelTitle, rawItems } = await fetchPlaylistMetaAndItems({ playlistId, apiKey });
      state.playlistTitle = playlistTitle;
      state.channelTitle = channelTitle;

      // Build items with URLs
      state.items = rawItems.map((x, idx) => ({
        index: idx + 1,
        videoId: x.videoId,
        title: x.title,
        url: `https://www.youtube.com/watch?v=${encodeURIComponent(x.videoId)}&list=${encodeURIComponent(playlistId)}`,
        durationSec: 0
      }));

      // durations
      const ids = state.items.map(i => i.videoId);
      if(ids.length === 0){
        throw new Error("No videos found in this playlist (or access is restricted).");
      }
      const durationMap = await fetchDurationsForVideoIds({ videoIds: ids, apiKey });

      let total = 0;
      state.items = state.items.map(it => {
        const sec = durationMap.get(it.videoId) || 0;
        total += sec;
        return { ...it, durationSec: sec };
      });
      state.totalDurationSec = total;

      setProgress(100, "Done.");
      updateUIAfterExtract();

      if(state.items.some(i => i.title === "Private video" || i.title === "Deleted video")){
        setMsg("Note: This playlist contains private/deleted videos. Those entries may have missing metadata.", "warn");
      } else {
        setMsg(`Extracted ${state.items.length} videos successfully.`, "info");
      }
    }catch(err){
      setMsg(`Error: ${err.message || String(err)}`, "error");
      setProgress(0, "Ready.");
    }finally{
      els.btnExtract.disabled = false;
      els.btnExtract.textContent = "Extract Playlist Links";
    }
  }

  function clearAll(){
    setMsg("");
    setProgress(0, "Ready.");
    els.playlistUrl.value = "";
    state = { playlistId:null, playlistTitle:null, channelTitle:null, items:[], totalDurationSec:0 };
    els.output.value = "";
    els.previewList.style.display = "none";
    els.previewList.innerHTML = "";
    els.statCount.textContent = "—";
    els.statDuration.textContent = "—";
    els.statDuration125.textContent = "—";
    els.statDuration150.textContent = "—";
    els.playlistTitlePill.textContent = "Playlist: —";
    els.channelPill.textContent = "Channel: —";
  }

  function saveKey(){
    const k = (els.apiKey.value || "").trim();
    if(!k){
      els.keyStatus.textContent = "Paste a key first.";
      return;
    }
    localStorage.setItem(LS_KEY, k);
    els.keyStatus.textContent = "Saved in this browser.";
    setTimeout(() => els.keyStatus.textContent = "", 2000);
  }

  function forgetKey(){
    localStorage.removeItem(LS_KEY);
    els.apiKey.value = "";
    els.keyStatus.textContent = "Removed from this browser.";
    setTimeout(() => els.keyStatus.textContent = "", 2000);
  }

  function syncKeyStatus(){
    const stored = localStorage.getItem(LS_KEY);
    if(stored && !els.apiKey.value){
      els.keyStatus.textContent = "A saved key exists in this browser.";
    } else {
      els.keyStatus.textContent = "";
    }
  }

  async function copyOutput(){
    const text = els.output.value || "";
    if(!text){
      setMsg("Nothing to copy yet. Extract a playlist first.", "warn");
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
      setMsg("Copied to clipboard.", "info");
      setTimeout(() => setMsg(""), 1500);
    }catch(e){
      setMsg("Copy failed (browser blocked). You can manually select and copy from the output box.", "warn");
    }
  }

  function downloadOutput(){
    const text = els.output.value || "";
    if(!text){
      setMsg("Nothing to download yet. Extract a playlist first.", "warn");
      return;
    }
    const fmt = els.format.value;
    const ext = fmt === "markdown" ? "md" : fmt === "csv" ? "csv" : "txt";
    const nameBase = (state.playlistTitle || "playlist").replace(/[^\w\s-]/g,"").trim().replace(/\s+/g,"-").slice(0,60) || "playlist";
    const filename = `${nameBase}-links.${ext}`;
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Events
  els.btnExtract.addEventListener("click", extract);
  els.btnClear.addEventListener("click", clearAll);
  els.btnSaveKey.addEventListener("click", saveKey);
  els.btnForgetKey.addEventListener("click", forgetKey);
  els.btnCopy.addEventListener("click", copyOutput);
  els.btnDownload.addEventListener("click", downloadOutput);

  els.format.addEventListener("change", () => {
    els.output.value = buildOutput();
  });
  els.includeDuration.addEventListener("change", () => {
    els.output.value = buildOutput();
  });

  // Allow pressing Enter to extract when focused on URL field
  els.playlistUrl.addEventListener("keydown", (e) => {
    if(e.key === "Enter") extract();
  });

  // Init
  (function init(){
    syncKeyStatus();
    const stored = localStorage.getItem(LS_KEY);
    if(stored){
      // Keep masked; user can replace it.
      // We'll not auto-fill password field for safety; just hint.
    }
  })();
</script>
</body>
</html>
